{"version":3,"sources":["../../src/controllers/user.js"],"names":["User","db","create","req","res","body","errors","isValid","firstname","lastname","username","role","email","password","status","json","findAll","where","then","user","length","newUser","bcrypt","genSalt","err","salt","hash","catch","login","originalPassword","dataValues","compare","isMatch","console","log","id","payload","jwt","sign","expiresIn","token","success","findAllUsers","findById","params","userId","msg","update","HospitalId","image","deleteUser","destroy"],"mappings":";;;;;;;AAAA;;;;AACA;;;;AACA;;;;AAEA;;;;AAIA;;;;AACA;;;;;;AAJA,IAAMA,OAAOC,iBAAGD,IAAhB;;AAEA;;;AAIA;AACA,IAAME,SAAS,SAATA,MAAS,CAACC,GAAD,EAAMC,GAAN,EAAc;AAAA,8BACC,wBAAqBD,IAAIE,IAAzB,CADD;AAAA,MACnBC,MADmB,yBACnBA,MADmB;AAAA,MACXC,OADW,yBACXA,OADW;;AAAA,kBASvBJ,IAAIE,IATmB;AAAA,MAGzBG,SAHyB,aAGzBA,SAHyB;AAAA,MAIzBC,QAJyB,aAIzBA,QAJyB;AAAA,MAKzBC,QALyB,aAKzBA,QALyB;AAAA,MAMzBC,IANyB,aAMzBA,IANyB;AAAA,MAOzBC,KAPyB,aAOzBA,KAPyB;AAAA,MAQzBC,QARyB,aAQzBA,QARyB;;AAW3B;;AACA,MAAG,CAACN,OAAJ,EAAa;AACX,WAAOH,IAAIU,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBT,MAArB,CAAP;AACD;;AAEDN,OAAKgB,OAAL,CAAa,EAAEC,OAAO,EAAEL,YAAF,EAAT,EAAb,EAAmCM,IAAnC,CAAwC,gBAAQ;AAC9C,QAAIC,KAAKC,MAAT,EAAiB;AACf,aAAOhB,IAAIU,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEH,OAAO,uBAAT,EAArB,CAAP;AACD,KAFD,MAEO;AACL,UAAIS,UAAU;AACZb,4BADY;AAEZC,0BAFY;AAGZC,0BAHY;AAIZC,kBAJY;AAKZC,oBALY;AAMZC;AANY,OAAd;AAQAS,yBAAOC,OAAP,CAAe,EAAf,EAAmB,UAACC,GAAD,EAAMC,IAAN,EAAe;AAChCH,2BAAOI,IAAP,CAAYL,QAAQR,QAApB,EAA8BY,IAA9B,EAAoC,UAACD,GAAD,EAAME,IAAN,EAAe;AACjD,cAAIF,GAAJ,EAAS,MAAMA,GAAN;AACTH,kBAAQR,QAAR,GAAmBa,IAAnB;AACA1B,eAAKE,MAAL,CAAYmB,OAAZ,EACGH,IADH,CACQ,gBAAQ;AACZd,gBAAIW,IAAJ,CAAS,EAAEI,UAAF,EAAT;AACD,WAHH,EAIGQ,KAJH,CAIS,eAAO;AACZvB,gBAAIU,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAES,QAAF,EAArB;AACD,WANH;AAOD,SAVD;AAWD,OAZD;AAaD;AACF,GA1BD;AA2BD,CA3CD;;AA6CA,IAAMI,QAAQ,SAARA,KAAQ,CAACzB,GAAD,EAAMC,GAAN,EAAc;AAAA,2BACE,qBAAkBD,IAAIE,IAAtB,CADF;AAAA,MAClBC,MADkB,sBAClBA,MADkB;AAAA,MACVC,OADU,sBACVA,OADU;;AAG1B;;;AACA,MAAG,CAACA,OAAJ,EAAa;AACX,WAAOH,IAAIU,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBT,MAArB,CAAP;AACD;;AANyB,mBAQEH,IAAIE,IARN;AAAA,MAQlBO,KARkB,cAQlBA,KARkB;AAAA,MAQXC,QARW,cAQXA,QARW;;;AAU1Bb,OAAKgB,OAAL,CAAa;AACXC,WAAO;AACLL;AADK;AADI,GAAb,EAKCM,IALD,CAKM,gBAAQ;;AAEZ;AACA,QAAI,CAACC,KAAKC,MAAV,EAAkB;AAChBd,aAAOM,KAAP,GAAe,iBAAf;AACA,aAAOR,IAAIU,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBT,MAArB,CAAP;AACD;;AAED,QAAIuB,mBAAmBV,KAAK,CAAL,EAAQW,UAAR,CAAmBjB,QAA1C;;AAEA;AACAS,uBACGS,OADH,CACWlB,QADX,EACqBgB,gBADrB,EAEGX,IAFH,CAEQ,mBAAW;AACf,UAAIc,OAAJ,EAAa;AACX;AACAC,gBAAQC,GAAR,CAAY,UAAZ;AAFW,iCAGcf,KAAK,CAAL,EAAQW,UAHtB;AAAA,YAGHK,EAHG,sBAGHA,EAHG;AAAA,YAGCzB,QAHD,sBAGCA,QAHD;;AAIX,YAAM0B,UAAU,EAAED,MAAF,EAAMzB,kBAAN,EAAhB,CAJW,CAIuB;AAClC;;AAEA2B,+BAAIC,IAAJ,CAASF,OAAT,EAAkB,QAAlB,EAA4B;AAC1BG,qBAAW;AADe,SAA5B,EAEG,UAACf,GAAD,EAAMgB,KAAN,EAAgB;AACjBpC,cAAIW,IAAJ,CAAS;AACP0B,qBAAS,IADF;AAEPD,mBAAO,YAAYA,KAFZ;AAGP7B,kBAAMQ,KAAK,CAAL,EAAQW,UAAR,CAAmBnB;AAHlB,WAAT;AAKD,SARD;AASD,OAhBD,MAgBO;AACLL,eAAOO,QAAP,GAAkB,sBAAlB;AACA,eAAOT,IAAIU,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBT,MAArB,CAAP;AACD;AACJ,KAvBD,EAuBGqB,KAvBH,CAuBS;AAAA,aAAOM,QAAQC,GAAR,CAAYV,GAAZ,CAAP;AAAA,KAvBT;AAwBD,GAxCD,EAwCGG,KAxCH,CAwCS;AAAA,WAAOvB,IAAIU,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACS,QAAD,EAArB,CAAP;AAAA,GAxCT;AAyCD,CAnDD;;AAqDA;AACA,IAAMkB,eAAe,SAAfA,YAAe,CAACvC,GAAD,EAAMC,GAAN,EAAc;AACjCJ,OAAKgB,OAAL,GACGE,IADH,CACQ,gBAAQ;AACZd,QAAIW,IAAJ,CAAS,EAAEI,UAAF,EAAT;AACD,GAHH,EAIGQ,KAJH,CAIS;AAAA,WAAOvB,IAAIU,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAES,QAAF,EAArB,CAAP;AAAA,GAJT;AAKD,CAND;;AAQA;AACA,IAAMmB,WAAW,SAAXA,QAAW,CAACxC,GAAD,EAAMC,GAAN,EAAc;AAC7B,MAAM+B,KAAKhC,IAAIyC,MAAJ,CAAWC,MAAtB;;AAEA7C,OAAKgB,OAAL,CAAa,EAAEC,OAAO,EAAEkB,MAAF,EAAT,EAAb,EACGjB,IADH,CACQ,gBAAQ;AACZ,QAAG,CAACC,KAAKC,MAAT,EAAiB;AACf,aAAOhB,IAAIW,IAAJ,CAAS,EAAE+B,KAAK,gBAAP,EAAT,CAAP;AACD;AACD1C,QAAIW,IAAJ,CAAS,EAAEI,UAAF,EAAT;AACD,GANH,EAOGQ,KAPH,CAOS;AAAA,WAAOvB,IAAIU,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAES,QAAF,EAArB,CAAP;AAAA,GAPT;AAQD,CAXD;;AAaA;AACA,IAAMuB,SAAS,SAATA,MAAS,CAAC5C,GAAD,EAAMC,GAAN,EAAc;AAAA,mBAC4BD,IAAIE,IADhC;AAAA,MACrBG,SADqB,cACrBA,SADqB;AAAA,MACVC,QADU,cACVA,QADU;AAAA,MACAuC,UADA,cACAA,UADA;AAAA,MACYrC,IADZ,cACYA,IADZ;AAAA,MACkBsC,KADlB,cACkBA,KADlB;;AAE3B,MAAMd,KAAKhC,IAAIyC,MAAJ,CAAWC,MAAtB;;AAEA7C,OAAK+C,MAAL,CACE;AACEvC,wBADF;AAEEC,sBAFF;AAGEE;AAHF,GADF,EAME,EAAEM,OAAO,EAAEkB,MAAF,EAAT,EANF,EAQGjB,IARH,CAQQ;AAAA,WAAQd,IAAIU,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAEI,UAAF,EAArB,CAAR;AAAA,GARR,EASGQ,KATH,CASS;AAAA,WAAOvB,IAAIU,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAES,QAAF,EAArB,CAAP;AAAA,GATT;AAUD,CAdD;;AAgBA;AACA,IAAM0B,aAAa,SAAbA,UAAa,CAAC/C,GAAD,EAAMC,GAAN,EAAc;AAC/B,MAAM+B,KAAKhC,IAAIyC,MAAJ,CAAWC,MAAtB;;AAEA7C,OAAKmD,OAAL,CAAa,EAAElC,OAAO,EAAEkB,MAAF,EAAT,EAAb,EACGjB,IADH,CACQ;AAAA,WAAMd,IAAIU,MAAJ,CAAWC,IAAX,CAAgB,EAAE+B,KAAK,qCAAP,EAAhB,CAAN;AAAA,GADR,EAEGnB,KAFH,CAES;AAAA,WAAOvB,IAAIU,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAAE+B,KAAK,mBAAP,EAArB,CAAP;AAAA,GAFT;AAGD,CAND;;QASI5C,M,GAAAA,M;QACA0B,K,GAAAA,K;QACAc,Y,GAAAA,Y;QACAC,Q,GAAAA,Q;QACAI,M,GAAAA,M;QACAG,U,GAAAA,U","file":"user.js","sourcesContent":["import bcrypt from 'bcryptjs';\r\nimport jwt from 'jsonwebtoken';\r\nimport passport from 'passport';\r\n\r\nimport db from '../models';\r\nconst User = db.User;\r\n\r\n// load input validation\r\nimport validateRegisterForm from '../validation/register';\r\nimport validateLoginForm from '../validation/login';\r\n\r\n// create user\r\nconst create = (req, res) => {\r\n  const { errors, isValid } = validateRegisterForm(req.body);\r\n  let { \r\n    firstname, \r\n    lastname, \r\n    username, \r\n    role,\r\n    email, \r\n    password,\r\n  } = req.body;\r\n\r\n  // check validation\r\n  if(!isValid) {\r\n    return res.status(400).json(errors);\r\n  }\r\n\r\n  User.findAll({ where: { email } }).then(user => {\r\n    if (user.length) {\r\n      return res.status(400).json({ email: 'Email already exists!' });\r\n    } else {\r\n      let newUser = { \r\n        firstname, \r\n        lastname, \r\n        username, \r\n        role,\r\n        email, \r\n        password, \r\n      };\r\n      bcrypt.genSalt(10, (err, salt) => {\r\n        bcrypt.hash(newUser.password, salt, (err, hash) => {\r\n          if (err) throw err;\r\n          newUser.password = hash;\r\n          User.create(newUser)\r\n            .then(user => {\r\n              res.json({ user });\r\n            })\r\n            .catch(err => {\r\n              res.status(500).json({ err });\r\n            });\r\n        });\r\n      });\r\n    }\r\n  });\r\n};\r\n\r\nconst login = (req, res) => {\r\n  const { errors, isValid } = validateLoginForm(req.body);\r\n\r\n  // check validation\r\n  if(!isValid) {\r\n    return res.status(400).json(errors);\r\n  }\r\n\r\n  const { email, password } = req.body;\r\n\r\n  User.findAll({ \r\n    where: { \r\n      email \r\n    } \r\n  })\r\n  .then(user => {\r\n\r\n    //check for user\r\n    if (!user.length) {\r\n      errors.email = 'User not found!';\r\n      return res.status(404).json(errors);\r\n    }\r\n     \r\n    let originalPassword = user[0].dataValues.password\r\n\r\n    //check for password\r\n    bcrypt\r\n      .compare(password, originalPassword)\r\n      .then(isMatch => {\r\n        if (isMatch) {\r\n          // user matched\r\n          console.log('matched!')\r\n          const { id, username } = user[0].dataValues;\r\n          const payload = { id, username }; //jwt payload\r\n          // console.log(payload)\r\n\r\n          jwt.sign(payload, 'secret', { \r\n            expiresIn: 3600 \r\n          }, (err, token) => {\r\n            res.json({\r\n              success: true,\r\n              token: 'Bearer ' + token,\r\n              role: user[0].dataValues.role\r\n            });\r\n          });\r\n        } else {\r\n          errors.password = 'Password not correct';\r\n          return res.status(400).json(errors);\r\n        }\r\n    }).catch(err => console.log(err));\r\n  }).catch(err => res.status(500).json({err}));\r\n};\r\n\r\n// fetch all users\r\nconst findAllUsers = (req, res) => {\r\n  User.findAll()\r\n    .then(user => {\r\n      res.json({ user });\r\n    })\r\n    .catch(err => res.status(500).json({ err }));\r\n};\r\n\r\n// fetch user by userId\r\nconst findById = (req, res) => {\r\n  const id = req.params.userId;\r\n  \r\n  User.findAll({ where: { id } })\r\n    .then(user => {\r\n      if(!user.length) {\r\n        return res.json({ msg: 'user not found'})\r\n      }\r\n      res.json({ user })\r\n    })\r\n    .catch(err => res.status(500).json({ err }));\r\n};\r\n\r\n// update a user's info\r\nconst update = (req, res) => {\r\n  let { firstname, lastname, HospitalId, role, image } = req.body;\r\n  const id = req.params.userId;\r\n\r\n  User.update(\r\n    {\r\n      firstname,\r\n      lastname,\r\n      role,\r\n    },\r\n    { where: { id } }\r\n  )\r\n    .then(user => res.status(200).json({ user }))\r\n    .catch(err => res.status(500).json({ err }));\r\n};\r\n\r\n// delete a user\r\nconst deleteUser = (req, res) => {\r\n  const id = req.params.userId;\r\n\r\n  User.destroy({ where: { id } })\r\n    .then(() => res.status.json({ msg: 'User has been deleted successfully!' }))\r\n    .catch(err => res.status(500).json({ msg: 'Failed to delete!' }));\r\n};\r\n\r\nexport { \r\n    create, \r\n    login, \r\n    findAllUsers, \r\n    findById, \r\n    update, \r\n    deleteUser \r\n}"]}